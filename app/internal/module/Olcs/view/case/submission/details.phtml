<?php

$case = $this->placeholder('case')->getValue();
$submission = $this->placeholder('submission')->getValue();
$selectedSectionsArray = $this->placeholder('selectedSectionsArray')->getValue();

$freetext = '';

$selectedIds = array_column($selectedSectionsArray, 'sectionId');

foreach ($allSections as $sectionId => $sectionDescription) {
    if (array_key_exists($sectionId, $selectedSectionsArray))
    {
        $freetext .= $this->submissionSectionDetails(
            $sectionId,
            $selectedSectionsArray[$sectionId]
        );
        if (isset($submissionConfig[$sectionId]['allow_comments']) && $submissionConfig[$sectionId]['allow_comments']) {
            $freetext .= $this->partial('case/submission/partials/comments',
                [
                    'sectionId' => $sectionId,
                    'section' => $selectedSectionsArray[$sectionId],
                    'caseId' => $case['id'],
                    'submissionId' => $submission['id']
                ]
            );
        }
    }
}

//last submission
echo $this->render('partials/read-only/main',
    [
        'header' => $submission['submissionTypeTitle'],
        'actions' => [
            [
                'label' => 'Return to list',
                'url' => $this->url(
                    'submission', [
                        'case' => $case['id'],
                        'action' => 'index'
                    ]
                )
            ],
            [
                'label' => 'Edit submission',
                'url' => $this->url(
                    'submission', [
                        'case' => $case['id'],
                        'action' => 'edit',
                        'submission' => $submission['id']
                    ]
                )
            ]
        ],
        'freetext' => $freetext
    ]
);

?>
<?php if (count($submission['submissionActions']) > 0): ?>
<h3>Submission actions</h3>

<ul class="submission-actions" style="width: 100%">
    <?php foreach ($submission['submissionActions'] as $sa): ?>
    <li class="submission-item">

        <h4><?php echo $sa['isDecision'] == 'Y' ? 'Descision' : 'Recommendation'; ?>:
            <?php echo $sa['submissionActionStatus']['description']; ?></h4>


        <?php $route = 'submission_action_' . ($sa['isDecision'] == 'Y' ? 'decision' : 'recommendation'); ?>

        <a class="submission-item__edit" href="<?php echo $this->url($route, ['action' => 'edit', 'id' => $sa['id']], [], true); ?>">Edit</a>
        <p><?php echo $sa['comment']; ?></p>
        <div class="submission-item__meta">
            <p><b>From</b> <?php echo $sa['senderUser']['name']; ?></p>
            <p><b>To</b> <?php echo $sa['recipientUser']['name']; ?></p>
            <p><b>Created</b> <?php echo date('H:i d/m/Y', strtotime($sa['createdOn'])); ?></p>
            <p><b>Urgent</b> <?php echo $sa['urgent']; ?></p>
        </div><!-- submission-item__meta -->
    </li><!-- submission-item -->
  <?php endforeach; ?>
</ul>

<?php endif; ?>

<div>&nbsp;</div>


<div class="actions-container" data-group="form-actions">
    <a href="<?php echo $this->url('submission_action_recommendation', ['action' => 'add'], [], true); ?>" class="action--primary large">Add recommendation</a>
    <a href="<?php echo $this->url('submission_action_decision', ['action' => 'add'], [], true); ?>" class="action--primary large">Add decision</a>
</div>
